<body data-current-user-id="<%= current_user.id %>">
<% if user_signed_in? %>
  <h1>Chat room</h1>
  <div class="row g-0 border rounded-3 shadow-sm position-relative overflow-hidden white-background">
    <div class="col-lg-12" style="max-height: 712px; min-height: 712px;">
      <div class="card h-100 border-0 bg-transparent pb-3">
        <!-- Messages -->
        <div class="card-body swiper scrollbar-hover overflow-hidden w-100 pb-0" data-swiper-options='{
          "direction": "vertical",
          "slidesPerView": "auto",
          "freeMode": true,
          "scrollbar": {
          "el": ".swiper-scrollbar"
          },
          "mousewheel": true
        }'>
        <div class="swiper-wrapper">
          <div class="swiper-slide h-auto">
            <!-- User message -->
            <div data-post-id="<%= @post.id %>" id="messages">
              <% @messages.each do |message| %>
                <% if message.user_id == current_user.id %>
                  <!-- Own message -->
                  <div class="message-own d-flex align-items-start justify-content-end mb-3" data-user-id="<%= message.user_id %>">
                    <div class="pe-2 me-1" style="max-width: 348px;">
                      <div class="bg-info bg-gradient text-light p-3 mb-1" style="border-top-left-radius: .5rem; border-bottom-right-radius: .5rem; border-bottom-left-radius: .5rem;"><%= message.content %></div>
                      <div class="d-flex justify-content-end align-items-center fs-sm text-muted">
                        <%= message.created_at.strftime('%Y年%m月%d日 %H:%M') %>
                      </div>
                    </div>
                  </div>
                <% else %>
                  <!-- Message from others -->
                  <div class="message-others d-flex align-items-start mb-3" data-user-id="<%= message.user_id %>">
                    <%= message.user.username %>
                    <div class="ps-2 ms-1" style="max-width: 348px;">
                      <div class="bg-secondary p-3 mb-1" style="border-top-right-radius: .5rem; border-bottom-right-radius: .5rem; border-bottom-left-radius: .5rem;"><%= message.content %></div>
                      <div class="fs-sm text-muted">
                        <%= message.created_at.strftime('%Y年%m月%d日 %H:%M') %>
                      </div>
                    </div>
                  </div>
                <% end %>
              <% end %>
            </div>
          </div>
        </div>
        <div class="swiper-scrollbar end-0"></div>
      </div>

      <!-- Footer (Send message form) -->
      <div class="card-footer d-sm-flex w-100 border-0 pt-3 pb-3 px-4">
        <div class="input-group">
          <input type="text" data-behavior="post_speaker" id="post_input" class="form-control form-control-lg" style="padding-right: 85px;">
          <button id="submit_button" class="btn btn-primary btn-icon btn-lg d-sm-inline-flex ms-1">
          <i class="bi bi-send"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
<% end %>
</body>

<script>
  document.addEventListener("turbo:load", function() {
    window.swiper = new Swiper('.swiper', {
      direction: 'vertical',
      slidesPerView: 'auto',
      freeMode: true,
      scrollbar: {
      el: '.swiper-scrollbar',
      },
      mousewheel: true,
    });

    setTimeout(function() {
      window.swiper.update();
      const swiperContainer = document.querySelector('.swiper');
      if (swiperContainer) {
          swiperContainer.scrollTop = swiperContainer.scrollHeight;
      }
    }, 100);
  });
</script>